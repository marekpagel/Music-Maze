<!DOCTYPE>
<html>
	<head>
		<title>Computer Graphcis - Basic II - Task 1.1</title>
		<script type="text/javascript" src="three.r73.js"></script>
		<script type="text/javascript" src="THREEx.KeyboardState.js"></script>
		<script type="text/javascript">

			//The usual three
			var renderer, scene, camera;

			var textureLoader = new THREE.TextureLoader();
			
			var lightTrajectory;
			var light;
			var keyboard = new THREEx.KeyboardState();

			function toRad(degree) {
				return Math.PI * 2 * degree / 360;
			}
		
			function onLoad() { 
				var canvasContainer = document.getElementById('myCanvasContainer'); 
				var width = 800; 
				var height = 500;
				
				//Initially we show the loading text under the canvas
				statusContainer = document.getElementById('status'); 
				statusContainer.innerHTML = 'Loading...';
				
				renderer = new THREE.WebGLRenderer(); 
				renderer.setSize(width, height);
				renderer.gammaInput = true; //You can try with (more correct way) and without gamma correction
				renderer.gammaOutput = true;
				canvasContainer.appendChild(renderer.domElement);
				
				scene = new THREE.Scene();
				
				//Create a perspective camera.
				//We are going to modify the camera for a third-person view later
				camera = new THREE.PerspectiveCamera(80, width / height, 1, 1000);
				camera.position.set(0,0,95);
				camera.up = new THREE.Vector3(0,1,0);
				
				//We add a red point light
				lightTrajectory = new THREE.ClosedSplineCurve3([
					new THREE.Vector3( 0, 7, -8 ),
					new THREE.Vector3( -2, 3, -5 ),
					new THREE.Vector3( -3, 6, 36 ),
					new THREE.Vector3( 8, 4, 39 ),
				]);
				light = new THREE.PointLight(0xaa3333);
				scene.add(light);
				
				//And a white directional light
				var directionalLight = new THREE.DirectionalLight(0xffffff);
				directionalLight.position.set(1, 1, 1);
				scene.add(directionalLight);
				
				//This is needed for texture loading from the web
				textureLoader.crossOrigin = 'Anonymous';
				
				left_turn([0,0,0], 100, [0,0,0], true);
				left_turn([-100,0,60],100,[0,Math.PI/2,0], false);
				right_turn([-40,0,80], 100, [0,0,0], false);
				corridor([-20,0,140], 100, [0,Math.PI/2,0], false);
				
				//camera.position.set(-50,0,200);
				//camera.rotation.set(0,Math.PI/2,0);
			}
			
			
			/**
			 * This function loads the floor texture.
			 */
			function onTextureLoaded(texture) {
				texture.wrapS = THREE.RepeatWrapping;
				texture.wrapT = THREE.RepeatWrapping;
				texture.repeat.set(2, 10);
				texture.needsUpdate = true;
				
				loaded();
			}
			
			var i = 0;
			var j = 0;
			var z = 0;
			
			/**
			 * Things are loaded. Initialize draw loop.
			 */
			function loaded() {
				statusContainer.innerHTML = 'Running.';
				draw();
				
				//moveCamera();
				//rotateCamera();
				//moveCamera();
			}
			
			function moveCamera() {
		        i++;
			    if (i >= 35) { return; }
			
			    setTimeout(function() {
			        camera.position.z = camera.position.z -= 1;
			        
			        moveCamera();
			    }, 100);
			}
			
			function rotateCamera() {
		        j++;
			    if (j >= 17) { return; }
			
			    setTimeout(function() {
			        camera.rotation.y += Math.PI / 30;
			        
			        rotateCamera();
			    }, 100);
			}
			
			function draw() {
				requestAnimationFrame(draw);
				
				parseControls(100);
				
				console.log(camera.position);

				renderer.render(scene, camera); //We render our scene with our camera
			}
			

			function parseControls(dt) {
				if(keyboard.pressed("left")){
					camera.rotation.set(0, camera.rotation.y + toRad(1 % 360), 0);
				}
				if(keyboard.pressed("right")){
					camera.rotation.set(0, camera.rotation.y - toRad(1 % 360), 0);
				}
				
				var forward = new THREE.Vector3(0,0,-1);
				forward.applyAxisAngle(new THREE.Vector3(0,1,0), camera.rotation.y);
				forward.multiplyScalar(0.2  );
				
				if(keyboard.pressed("up")){
					camera.position.add(forward);
				}
				if(keyboard.pressed("down")){
					camera.position.sub(forward);
				}
			}

			function right_turn(position, length, rotation, with_backwall) {
			    var position = position == undefined ? [0,0,100] : position;
			    var length   = length   == undefined ? 100       : length;
			    var rotation = rotation == undefined ? [0,0,0]   : rotation;
			    var with_backwall = with_backwall == undefined ? true : with_backwall;
			
			    var x = position[0]; var y = position[1]; var z = position[2];
			    var xr = rotation[0]; var yr = rotation[1]; var zr = rotation[2];

				var mesh = new THREE.Mesh();
				var halfPi = Math.PI / 2;
				
				var leftWall = createWall(0x555555, length, 20);
				leftWall.position.set(-10, 0, 40);
				leftWall.rotation.set(0, halfPi, 0);
				mesh.add(leftWall);
				
				var rightWall1 = createWall(0x555555, 20, 20);
				rightWall1.position.set(10, 0, 80);
				rightWall1.rotation.set(0, -halfPi, 0);
				mesh.add(rightWall1);

				var rightWall2 = createWall(0x555555, 60, 20);
				rightWall2.position.set(10, 0, 20);
				rightWall2.rotation.set(0, -halfPi, 0);
				mesh.add(rightWall2);
				
				//var rightWall = createWall(0x333333, 100, 20);
				//rightWall.position.set(10, 0, 40);
				//rightWall.rotation.set(0, -halfPi, 0);
				//mesh.add(rightWall);
				
				if (with_backwall) {
				    var backWall = createWall(0x444444, 20, 20);
				    backWall.position.set(0, 0, -10);
				    mesh.add(backWall);
				}
				
				var ceiling = createWall(0x111111, 20, 100);
				ceiling.position.set(0, 10, 40);
				ceiling.rotation.set(halfPi, 0, 0);
				mesh.add(ceiling);
				
				var floor = createWall(0x222222, 20, 100);
				floor.position.set(0, -10, 40);
				floor.rotation.set(-halfPi, 0, 0);
				
				//We load this texture for the floor. Overriding the material assigned to us in the createWall
				floor.material = new THREE.MeshLambertMaterial({
					map: textureLoader.load('http://cglearn.codelight.eu/files/course/7/textures/wallTexture2.jpg', onTextureLoaded)
				});
				mesh.add(floor);

				mesh.position.set(x,y,z);
				mesh.rotation.set(xr,yr,zr);
				
				scene.add(mesh);
				
				//corridor([x-100, y, z+60], length, [0,halfPi,0]);
				//camera.position.set(-20,0,150);
			}

			function left_turn(position, length, rotation, with_backwall) {
			    var position = position == undefined ? [0,0,100] : position;
			    var length   = length   == undefined ? 100       : length;
			    var rotation = rotation == undefined ? [0,0,0]   : rotation;
			    var with_backwall = with_backwall == undefined ? true : with_backwall;
			
			    var x = position[0]; var y = position[1]; var z = position[2];
			    var xr = rotation[0]; var yr = rotation[1]; var zr = rotation[2];

				var mesh = new THREE.Mesh();
				var halfPi = Math.PI / 2;
				
				var leftWall1 = createWall(0x555555, 20, 20);
				leftWall1.position.set(-10, 0, 80);
				leftWall1.rotation.set(0, halfPi, 0);
				mesh.add(leftWall1);

				var leftWall2 = createWall(0x555555, 60, 20);
				leftWall2.position.set(-10, 0, 20);
				leftWall2.rotation.set(0, halfPi, 0);
				mesh.add(leftWall2);
				
				var rightWall = createWall(0x333333, 100, 20);
				rightWall.position.set(10, 0, 40);
				rightWall.rotation.set(0, -halfPi, 0);
				mesh.add(rightWall);
				
				if (with_backwall) {
				    var backWall = createWall(0x444444, 20, 20);
				    backWall.position.set(0, 0, -10);
				    mesh.add(backWall);
				}
				
				var ceiling = createWall(0x111111, 20, 100);
				ceiling.position.set(0, 10, 40);
				ceiling.rotation.set(halfPi, 0, 0);
				mesh.add(ceiling);
				
				var floor = createWall(0x222222, 20, 100);
				floor.position.set(0, -10, 40);
				floor.rotation.set(-halfPi, 0, 0);
				
				//We load this texture for the floor. Overriding the material assigned to us in the createWall
				floor.material = new THREE.MeshLambertMaterial({
					map: textureLoader.load('http://cglearn.codelight.eu/files/course/7/textures/wallTexture2.jpg', onTextureLoaded)
				});
				mesh.add(floor);

				mesh.position.set(x,y,z);
				mesh.rotation.set(xr,yr,zr);
				
				scene.add(mesh);
				
				//corridor([x-100, y, z+60], length, [0,halfPi,0]);
				//camera.position.set(-20,0,150);
			}

			function corridor(position, length, rotation, with_backwall) {
			    var position = position == undefined ? [0,0,100] : position;
			    var length   = length   == undefined ? 100       : length;
			    var rotation = rotation == undefined ? [0,0,0]   : rotation;
			
			    var x = position[0]; var y = position[1]; var z = position[2];
			    var xr = rotation[0]; var yr = rotation[1]; var zr = rotation[2];
			
				var corridor = new THREE.Mesh();
				var halfPi = Math.PI / 2;
				
				var leftWall = createWall(0x555555, length, 20);
				leftWall.position.set(-10, 0, 40);
				leftWall.rotation.set(0, halfPi, 0);
				corridor.add(leftWall);
				
				var rightWall = createWall(0x333333, length, 20);
				rightWall.position.set(10, 0, 40);
				rightWall.rotation.set(0, -halfPi, 0);
				corridor.add(rightWall);
				
				if (with_backwall) {
				    var backWall = createWall(0x444444, 20, 20);
				    backWall.position.set(0, 0, -10);
				    corridor.add(backWall);
				}
				
				var ceiling = createWall(0x111111, 20, length);
				ceiling.position.set(0, 10, 40);
				ceiling.rotation.set(halfPi, 0, 0);
				corridor.add(ceiling);
				
				var floor = createWall(0x222222, 20, length);
				floor.position.set(0, -10, 40);
				floor.rotation.set(-halfPi, 0, 0);
				
				//We load this texture for the floor. Overriding the material assigned to us in the createWall
				floor.material = new THREE.MeshLambertMaterial({
					map: textureLoader.load('http://cglearn.codelight.eu/files/course/7/textures/wallTexture2.jpg', onTextureLoaded)
				});
				corridor.add(floor);
				
				corridor.position.set(x,y,z);
				corridor.rotation.set(xr,yr,zr);
				
				scene.add(corridor);
			}
			
			function createWall(colorCode, width, height) {
				var geometry = new THREE.PlaneGeometry(width, height, width, height);
				var material = new THREE.MeshBasicMaterial({color: colorCode});
				var wall = new THREE.Mesh(geometry, material);
				
				return wall;
			}
			
		</script>
	</head>
	<body onload="onLoad()">
		<div id="myCanvasContainer"></div>
		<div id="stat"></div>
		<div id="status"></div>
	</body>
</html>
